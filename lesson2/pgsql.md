#PostgreSql

## Урок 2.

## Создаём таблицу c названием goods:

```sql
    CREATE TABLE "public"."goods" ("id" serial, "title" varchar(255),
    "description" text,
    "short_annotation" varchar(127),
    "vendor_code" char(8) NOT NULL,
    "image_url" varchar(255),
    "price" numeric(8,2) NOT NULL CHECK("price" > 0),
    "sales_start_day" timestamptz DEFAULT now(),
    "quantity" smallint CHECK ("quantity" >= 0),
    "exists" boolean DEFAULT false);
```
Основные отличия от других БД: Вместо decimal в MySql используем numeric. Хотя в MySql тоже есть numeric синоним decimal,
однако в PostreeSql нет типа decimal - синонима numeric. Кроме того, в PostreeSql нет директивы unsigned для ограничения
целочисленных значений, поэтому мы задаём это явно. При этом у нас значение не может быть равно и 0, что в данном случае
оправданно. Например владелец магазина решил бороться с разгильдяйством, например когда ответственные зы выгрузку информации
о товарах люди не заморачиваются и пишут вместо цены 0. Напротив в колонке количество может быть 0, что вполне логично,
поэтому >=, т.е. аналог unsigned.
Для поля short_annotation аналога tinytext в Pgsql нет, поэтому будем использовать тип varchar(127), т.е такая же длина как
и у tinytext (для кириллицы).
Ну и обращаю внимание, что для поля даты использовать специальный тип timestamptz, который отличается от timestamp тем что
время хранится в UTC. т.е. не учитываются часовые пояса, что позволяет решать множество проблем.
Значение по умолчанию мы задаем при помощи функции now().


###Попробуем вставить данные. Контент будет то же самый, что и для других БД:
```sql
INSERT INTO "goods" ("title", "description", "short_annotation", "vendor_code", "image_url", "price", "quantity", "exists")
VALUES ('WeThePeople Envy',
        'Он всегда совершенен. Тем не менее, из года в год мы одержимы желанием сделать его ещё лучше, байком мечты любого райдера, желающего кататься как Про. Его рама и вилка, выполненные на 100% из 4130 Sanco, получившие термообработку и захватывающий дух дизайн Black Titan. Гармоничное дополнение в виде россыпи украшающих фреймсет компонентов Eclat, включая жирные покрышки Stevie Churchill Signature и шатуны Aeon, готовые крошить бетон. Трепетное внимание к деталям выражено и в наличие втулок Blind, за качество которых ручается сам Shane Weston. Зверь, вызывающий зависть, стал ещё лучше.',

        'Главной особенностью велосипеда BMX является полное отсутствие подвески и наличие всего лишь одной передачи. В остальном же вариации могут быть разными. Еще одно, не менее важное отличие - очень маленький вес, в пределах 11 кг.',
        12124322,
        '/images/bicycle1.png',
        44040,
        7,
        1);
```
####Получаем ошибку:
```sql
ERROR:  column "exists" is of type boolean but expression is of type integer
```
####Исправляем наш boolean на правильный - true и повторяем запрос:
в ответ получаем ещё одну ошибку:
```sql
ERROR:  value too long for type character varying(127)
```
#### Чтож, всё ожидаемо, необходимо урезать строку short_annotation до 127 байт, делаем это и получаем положительный ответ
```sql
Query returned successfully: one row affected, 105 msec execution time.
```
Обратим внимание на колонку время - "2016-09-22 20:55:13.962777+00" Оно выводится с точностью до микросекунд, а не как
в MySql до секунд. Также есть параметр +00, для учета поясности. Пока не будем вникать что это значит, поскольку тема достаточно
обширна. Отмечю лишь что это время отличается от московского на 3 часа.
###Вводим следующий запрос
```sql
INSERT INTO "goods" ("title", "description", "short_annotation", "vendor_code", "image_url", "price", "quantity", "exists")
VALUES ('Norco AURUM C7.1',
        'Этот карбоновый боец создан в тесном сотрудничестве с командой Norco Factory Racing и проверен в гонках Кубка мира по даунхиллу. Технология изменения размеров рамы Gravity Tune позволяет райдеру найти идеальную посадку и правильно распределять вес тела. Колеса 650B пришли в скоростной спуск всерьез и надолго, а вместе с ними вы получаете дополнительное сцепление в поворотах и меньше тряски на неровностях. Трансмиссия X0 DH на 7 скоростей и карбоновые шатуны от Sram существенно облегчают байк, а руль Race Face из углеволокна шириной 800 мм делает управление легким и точным в любых условиях.',

        'Горный велосипед - двухподвес',
        432563473,
        '/images/bicycle2.png',
        435241120.123,
        2,
        true);
```
####И разумеется получаем ошибку, так как ввели лишнюю строку в поле артикул - vendor_code
```sql
ERROR:  value too long for type character(8)
```
###Повторяем запрос и снова фейл
```sql
ERROR:  numeric field overflow
DETAIL:  A field with precision 8, scale 2 must round to an absolute value less than 10^6.
```
####Поправляем и получаем положительный ответ. Обратим внимание на строку price. Мы поставили 3 знака после плавающей точки
и запрос прошёл успешно. Проверяем данные в таблице и обнаруживаем лишь два знака после точки. Собственно текст предыдущей
ошибки это поведение коссвенно объясняет. Программа пытается округлить до абсолютного значения. В отношении дробной части
числа нет никакихпроблем
###И ещё один запрос
```sql
INSERT INTO "goods" ("title", "description", "short_annotation", "vendor_code", "image_url", "price", "quantity", "exists")
VALUES ('GT FORCE X Carbon PRO',
        'Разнообразие – вот, пожалуй, самое короткое и емкое определение All Mountain. Любой из Force проведет вас везде, где только может проехать велосипед, и бережно вернет домой. А флагман линейки Force X Carbon Pro сделает это с необычайными легкостью и изяществом. Полностью карбоновая рама с подвеской A.O.S. 150 миллиметров, колеса 27.5 дюймов, элитный набор компонентов - всё в этом байке нацелено на то, что вы проведете в седле весь день, покорите новые вершины, насладитесь длинными спусками, а когда вернетесь домой – будете с улыбкой вспоминать прошедший день и планировать новые приключения.',

        'Горный велосипед - двухподвес даунхил',
         2324668,
        '/images/bicycle3.png',
        '241120',
        3,
        '');
```
И снова boolean:
```sql
ERROR:  invalid input syntax for type boolean: ""
```
Однако, помещаем в кавычки специальный символ, например 'f' и наш запрос успешно проходит. Проверяем таблицу и видим в поле "exists" false.
###Вставляем ещё одну запись. Однако в отличие от MySql мы уже не будем вводить в поле exist число, так как уже на первом запросе нам
система ответила что с числами boolean тип не работает. Попробуем ввести в кавычки true только не дописав его, например 'tru'.
```sql
INSERT INTO "goods" ("title", "description", "short_annotation", "vendor_code", "image_url", "price", "quantity", "exists")
VALUES ('Jamis XENITH PRO',
        'Для многих людей шоссейный велосипед олицетворяет единственную правильную сущность двухколесной машины. Именно для таких людей Jamis из года в год совершенствует свою шоссейную линейку, и эта модель весом 7,2 кг отвечает самым высоким требованиям любителей гонок по асфальту. Полностью карбоновая рама и вилка, а также оборудование Sram Force22 позволят не только тренироваться с максимальной эффективностью, но и бороться за победу в соревнованиях.',

        'Шоссейный велосипед нового поколения',
        12145468,
        '/images/bicycle4.png',
        241120,
        2,
        'tru');
```
###Запрос успешно проходит и в поле вставилось значение true. Т.е. в отличие от MySql который не обращает внимание на строку и
принимает её как false, за исключением случая если в строке полностью написано true или false, PostgreSql как бы пытается "угадать"
по маске запроса что пользователь пытался ввести что то похожее на true или false и вставляет соотвествующее значение.